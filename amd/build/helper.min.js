/**
 * Define the function with a clear and descriptive name, and then call it from other functions or code blocks as needed
 *
 * @module     block_learnerscript/helper
 * @copyright  2023 Moodle India Information Solutions Private Limited
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("block_learnerscript/helper",["jquery","block_learnerscript/ajax","block_learnerscript/ajaxforms","core/str","core/modal_factory","core/modal_events","core/ajax","core/notification","block_learnerscript/smartfilter"],(function($,ajax,AjaxForms,Str,ModalFactory,ModalEvents,Ajax,notification,smartfilter){return{sendmessage:function(args,username){Str.get_strings([{key:"sendmessage",component:"block_learnerscript"},{key:"messageconfirmation",component:"block_learnerscript"},{key:"messagesent",component:"block_learnerscript"},{key:"supplyvalue",component:"block_learnerscript"},{key:"messagesending",component:"block_learnerscript"},{key:"close",component:"block_learnerscript"},{key:"submit",component:"moodle"}]).then((function(s){var userid=args.userid,reportinstance=args.reportinstance,formid="form_sendsms"+userid,container=$("#sendsms_"+reportinstance+"_"+userid).parents("table");$("#ls_sendsms_"+reportinstance+"_"+userid).length<1&&$("#sendsms_"+reportinstance+"_"+userid).append('<div id="ls_sendsms_'+reportinstance+"_"+userid+'" class="sendmessage"><div class="messageloading"></div><form id="'+formid+'" ><textarea id="text_'+formid+'" type="text" name="message"></textarea><input type="submit" value = "'+s[6]+'"></form></div>');var dlg=$("#ls_sendsms_"+reportinstance+"_"+userid).dialog({resizable:!0,autoOpen:!1,width:"20%",title:s[0],modal:!1,dialogClass:"sendsmsdialog",show:{effect:"slide",duration:1e3},position:{my:"left",at:"right",of:"#sendsms_"+reportinstance+"_"+userid,within:container},open:function(){$(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-close").html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");var Closebutton=$(".ui-icon-closethick").parent();$(Closebutton).attr({title:s[5]}),$(".sendmessage").not(this).each((function(){$(this).remove()}))},close:function(){$(this).dialog("destroy").remove()}});return dlg.dialog("open"),$("#"+formid).submit((function(e){e.preventDefault();var helper=require("block_learnerscript/helper");if(document.getElementById("text_"+formid).value){var url=require("core/url");$(".messageloading").html('<center><img src="'+url.imageUrl("loader","block_learnerscript")+'" alt="'+s[4]+'" title="'+s[4]+'"/></center>'),$("#"+formid).hide(),Ajax.call([{methodname:"core_message_send_instant_messages",args:{messages:[{touserid:args.userid,text:$("#"+formid).serializeObject().message,textformat:0}]}}])[0].done((function(){var message=s[2]+username;helper.notifications(message),dlg.dialog("close")})).fail((function(ex){$(".messageloading").html('<div class="alert alert-warning">'+ex.message+"</div>")}))}else $(".messageloading").html('<div class="alert alert-danger">'+s[3]+"</div>")})),"true"})).fail()},ViewReportFilters:function(args){$("."+args.activefilter).toggleClass("show"),$("."+args.inactivefilter).removeClass("show")},deleteConfirm:function(args){return Str.get_strings([{key:"deleteconfirmation",component:"block_learnerscript"},{key:"deleteallconfirm",component:"block_learnerscript"},{key:"confirm",component:"block_learnerscript"},{key:"close",component:"block_learnerscript"}]).then(function(s){ModalFactory.create({title:s[0],type:ModalFactory.types.SAVE_CANCEL,body:s[1]}).done(function(modal){this.modal=modal,modal.setSaveButtonText(s[2]),modal.getRoot().on(ModalEvents.save,(function(e){e.preventDefault();var helper=require("block_learnerscript/helper");Ajax.call([{methodname:"block_learnerscript_"+args.action,args:args}])[0].done((function(){$(".plotgraphcontainer").removeClass("show").addClass("hide"),$("#plotreportcontainer"+args.reportid).html("");var tabdata=$("#"+args.cid).attr("aria-controls");$("[data-cid='"+args.cid+"']").remove(),$("#"+tabdata).remove(),$("#report_plottabs li:eq(0) a").length<1&&$("#report_plottabs").remove(),helper.notifications(s[2])})).fail(),modal.hide(),modal.destroy()})),modal.show(),$(".modal-header button.close").attr("title",s[3])}.bind(this))}.bind(this))},validatebasicform:function(validate){var getreport=[];return void 0===validate&&$.each($(".basicparamsform select"),(function(index,value){0==$(value).val()&&getreport.push(0)})),getreport},Select2Ajax:function(args){Str.get_strings([{key:"selectonlyvalues",component:"block_learnerscript"},{key:"valuesnotsupported",component:"block_learnerscript"}]).then((function(s){$("select[data-select2-ajax='1']").each((function(){var $blockname,methodname2,instanceid=$(this).data("instanceid"),reportinstance=instanceid||args.reportid;("rolewiseusers"==args.action&&(args.reportid=$(this).data("reportid"),args.courses=$('[name="filter_courses"]').val()),"userlist"===args.action&&(args.setminimuminputlength=2,args.courses=$('[name="filter_courses"]').val()),$(this).hasClass("select2-hidden-accessible"))||$(this).select2({ajax:{data:function(params){var dataaction=$(this).data("action");if("filterusers"!=dataaction&&"filter_courses"!=dataaction||(args.action=dataaction,args.basicparamdata=JSON.stringify(smartfilter.BasicparamsData(reportinstance)),args.fiterdata=JSON.stringify(smartfilter.FilterData(reportinstance)),args.reportinstanceid=instanceid,args.courses=$('[name="filter_courses"]').val()),"rolewiseusers"==args.action){delete args.schuserslist,delete args.scheduleid,args.roleid=$("#id_role"+reportinstance).val();var roleid=args.roleid.split("_");args.roleid=roleid[0],args.contextlevel=roleid[1],args.courses=$('[name="filter_courses"]').val()}return $.extend(params,args),methodname2=args.action,$blockname="userlist"===methodname2?"block_reportdashboard_":"block_learnerscript_",params},transport:function(params,success){var promise=Ajax.call([{methodname:$blockname+methodname2,args:params.data}]);promise[0].done((function(data){data=$.parseJSON(data),success(data)})),promise[0].fail((function(){}))},processResults:function(data,params){params.page=params.page||1;var pagination=!1;return pagination="userlist"!==args.action&&"filter_courses"!=args.action&&"filterusers"!=args.action&&10*params.page<data.total_count,{results:data.items,pagination:{more:pagination}}}},escapeMarkup:function(markup){return markup},minimumInputLength:args.setminimuminputlength||1,maximumselectionlength:args.maximumselectionlength,language:{maximumSelected:function(){if("filter_courses"==args.action||"filterusers"==args.action)return s[0]}},templateResult:function(repo){return repo.loading?repo.text||s[1]:repo.text||s[1]},templateSelection:function(repo){var markup;-1==repo.id&&"rolewiseusers"==args.action?markup="<a href='javascript:void(0)' class='viewschusers'onclick='(function(e){ require(\"block_learnerscript/schedule\").viewschusers({reportid:"+(repo.element.form.dataset.reportid||0)+",scheduleid:"+(repo.element.form.dataset.scheduleid||-1)+", reportinstance:"+reportinstance+"}) })(event);'>"+repo.text+"</a>":markup=repo.text;return markup}}).on("select2:select",(function(){if("reportlist"==args.action){var reportid=$(this).val();window.location=M.cfg.wwwroot+"/blocks/learnerscript/viewreport.php?id="+reportid}}))}))}))},getQueryParameters:function(str){return(str||document.location.search).replace(/(\?)/,"&").split("&").map(function(n){return this[(n=n.split("="))[0]]=n[1],this}.bind({}))[0]},DrilldownReport:function(){var self=this;$("td a").click((function(e){var url=$(this).attr("href"),drillurl=self.getQueryParameters(url);url.indexOf("viewreport.php")<=0||"download"in drillurl||(e.preventDefault(),self.ReportModelFromLink({container:$(this),url:url}))}))},ReportModelFromLink:function(args){var tableid=args.container.parents().closest("table").attr("id"),tablewidth=$("#"+tableid).width(),drillurl=this.getQueryParameters(args.url),reportid=parseInt(drillurl.id),filter={};args.url.indexOf("viewreport.php")<=0||"download"in drillurl||($.each(drillurl,(function(key,val){key.indexOf("filter")>=0&&(filter[key]=val)})),(0==$("#reportcontainer"+reportid).length||0==$("#plotreportcontainer"+reportid).length)&&($("body").append('<div id="reportcontainer'+reportid+'" style="display:none;"></div>'),$("body").append('<div id="plotreportcontainer'+reportid+'" class="dialogplot" style="display:none;"></div>'),ajax.call({args:{action:"disablecolumnstatus",reportid:reportid},url:M.cfg.wwwroot+"/blocks/learnerscript/ajax.php"}).done((function(response){var reporttypes=response;require(["block_learnerscript/reportwidget"],(function(reportwidget){reportwidget.CreateDashboardwidget({reportid:reportid,reporttype:response,basicparams:JSON.stringify(filter),lsfstartdate:0,lsfenddate:$.now()})})),$("#"+("table"==reporttypes?"reportcontainer":"plotreportcontainer")+reportid).dialog({resizable:!0,autoOpen:!1,dialogClass:"drilldown"+reportid,width:tablewidth,title:"",appendTo:"#"+tableid,modal:!0,position:{my:"center",at:"top",of:"#"+tableid},open:function(){$(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-close").html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");var Closebutton=$(".ui-icon-closethick").parent();$(Closebutton).attr({title:"Close"}),Str.get_string("viewmore","block_learnerscript").then((function(s){$(".drilldown"+reportid).append("<a href="+args.url+'><span class="reportdashboard_right">'+s+"</span></a>")}))},close:function(){$(this).dialog("destroy").remove()}}).dialog("open").prev(".ui-dialog-titlebar").css("color","#0C75B6")}))))},PlotForm:function(args){var url=M.cfg.wwwroot+"/blocks/learnerscript/ajax.php";Str.get_string("plotgraph","block_learnerscript").then((function(s){args.title=args.title?args.title:s})),AjaxForms.init(args,url)},dropdown:function(child){$("#"+child).toggle()},notifications:function(elements,notifytype){notifytype=notifytype||"success",$.notify({message:elements},{type:notifytype})}}}));

//# sourceMappingURL=helper.min.js.map